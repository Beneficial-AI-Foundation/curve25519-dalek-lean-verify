name: Modifications Diff

# This workflow ensures that src-modifications.diff is kept in sync with the actual
# modifications made to the curve25519-dalek source code.
# The diff is generated by comparing the upstream source (at the specific commit)
# with the modified source in this repository.
#
# This check will fail if someone modifies the source code but forgets to regenerate
# src-modifications.diff, ensuring the documentation of changes is always up to date.

on:
  pull_request:
  push:

jobs:
  modifications:
    name: Modifications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate src-modifications.diff
        run: npm run src-diff

      - name: Check if src-modifications.diff is up to date
        run: |
          if git diff --exit-code src-modifications.diff; then
            echo "✅ src-modifications.diff is up to date!"
          else
            echo "❌ src-modifications.diff is out of date!"
            echo ""
            echo "The src-modifications.diff file needs to be regenerated."
            echo ""
            echo "Please run the following command and commit the updated src-modifications.diff:"
            echo ""
            echo "  npm run src-diff"
            echo "  git add src-modifications.diff"
            echo "  git commit -m 'Update src-modifications.diff'"
            echo ""
            echo "Differences found:"
            git diff src-modifications.diff
            exit 1
          fi
