# Contributing to curve25519-dalek-verify

We can all benefit in many ways from interacting with each other!
Contributions are very welcome.

For efficiency it's useful to read the info about the project on the
[project page](https://beneficial-ai-foundation.github.io/curve25519-dalek-lean-verify/)
and get in contact with us (contact us through Zulip or whatever means you prefer).

Repo contributions follow the standard fork and PR method.

## Lean Code Style

We follow the [Mathlib4 contributing guidelines](https://leanprover-community.github.io/contribute/index.html)
as closely as possible, including naming conventions and general code style.
We prioritize getting proofs done over code perfection, but the guidelines below
should be respected.

### Spec Theorem Format

New spec theorems should follow the Aeneas WP (weakest precondition) style
using `⦃ ... ⦄` syntax. The canonical layout is:

```lean
@[progress]
theorem fun_name_spec
    (a : argType) (b : argType)
    (h : pre_condition) :
    fun_name a b ⦃ result : resultType =>
      post_condition_1 ∧
      post_condition_2 ⦄ := by
  sorry
```

The WP brackets `⦃` and `⦄` are typed as `\{{` and `\}}` respectively in
VS Code with the Lean 4 extension (Unicode characters U+2983 and U+2984).

Key points:
- Tag with `@[progress]` so the Aeneas `progress` tactic can chain specs
- Arguments and preconditions on separate indented lines
- The function call and WP binder on the `:` line
- Postconditions as a conjunction inside `⦃ ... ⦄`
- Proof body indented at one level (2 spaces)

Some older specs use the existential form (`∃ result, f = ok result ∧ ...`).
Both forms are acceptable, but **new specs should prefer the WP style**.

### Avoiding Flexible Tactics

Flexible (non-terminal) tactics make proofs fragile and harder to maintain.
Avoid them as much as possible:

- **`simp`**: Use `simp?` to obtain the explicit lemma list, then replace with
  `simp only [...]`. This makes the proof deterministic and resistant to
  changes in the simp set.
- **`simp_all`**: Same rule — use `simp_all?` to obtain `simp_all only [...]`.
- **`grind`**: Prefer more targeted alternatives (`omega`, `ring`,
  `linear_combination`, `decide`, etc.) where feasible.
- **`exact?`** / **`apply?`**: Use these *interactively* to discover the right
  lemma, then replace with the explicit `exact` or `apply` call.

When a flexible tactic is genuinely the best option (e.g. a `simp` that closes
a goal and whose lemma list would be impractically long), document why in a
short comment.

### Linters

Linter warnings should be **resolved, not suppressed**. Avoid `#check`/`#eval`
leftovers and `set_option linter.* false` unless there is a clear justification
documented in a comment.

### Heartbeats

Keep `set_option maxHeartbeats` increases to the bare minimum needed.
Use multiples of **200000** as a standard increment (e.g. 400000, 800000).
If a proof requires a very large heartbeat budget, consider refactoring it
into helper lemmas to bring the cost down.

### Comments and Documentation

We are more relaxed than Mathlib on documentation density — not every helper
lemma needs a docstring. However, **longer explanatory comments are encouraged**
in the following situations:

- **Algorithmic context**: Explaining what the Rust code does and why the proof
  takes a particular shape.
- **Tech debt markers**: When a mathematical sub-proof is deferred (`sorry`) or
  a workaround is used, explain what remains to be done and why.
- **Non-obvious proof strategies**: If a proof block relies on a subtle
  algebraic identity or a specific property of the field (e.g. Euler's
  criterion, Fermat's little theorem), a brief comment helps future readers.

Module-level doc comments (`/-! ... -/`) at the top of spec files are
appreciated — see existing specs for examples.

### Auto-generated Files

**Never edit** `Types.lean` or `Funs.lean` — these are auto-generated by Aeneas.
If extraction produces incorrect output, fix it via `aeneas-tweaks.txt` or
upstream Rust changes, then re-extract.

### Sync Status

After adding or modifying any spec file, run:

```bash
lake exe syncstatus
```

and commit the updated `functions.json` and `status.csv`. CI will reject PRs
where these are out of date.